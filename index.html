<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>pH Scanner</title>
    
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body { 
            background: #F2F2F7;
            color: #1C1C1E;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100dvh; 
            overflow: hidden;
        }

        /* å…±é€šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ãƒšãƒ¼ã‚¸æ§‹é€  */
        .page {
            width: 100%;
            height: 100dvh;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            transform: scale(0.96);
            pointer-events: none;
            transition: opacity 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: #F2F2F7;
            z-index: 1;
        }

        .page.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            z-index: 10;
        }

        /* ----------------
           ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ 
           ---------------- */
        .home-page {
            height: 100dvh;
            overflow-y: auto;
            padding: max(env(safe-area-inset-top), 20px) 20px 120px 20px; /* ä¸‹éƒ¨ã«ãƒœã‚¿ãƒ³ç”¨ã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ */
            max-width: 600px;
            margin: 0 auto;
        }

        .home-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 24px;
            padding-top: 10px;
        }

        .home-titles { text-align: left; }
        .home-title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: #000;
        }
        .home-subtitle {
            font-size: 13px;
            font-weight: 600;
            color: #8E8E93;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .card-full { grid-column: span 2; }

        .card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 12px;
        }

        .card-icon { color: #0A84FF; }

        .card-label {
            font-size: 13px;
            font-weight: 600;
            color: #8E8E93;
        }

        /* å¥åº·ç‡ãƒªãƒ³ã‚° */
        .score-ring-container {
            position: relative;
            width: 100%;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -5px;
        }

        .score-circle { transform: rotate(-90deg); transform-origin: 50% 50%; }
        .score-background { stroke: #F2F2F7; fill: none; stroke-width: 10; }
        .score-progress {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 251;
            stroke-dashoffset: 251;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.2, 0.8, 0.2, 1), stroke 0.3s ease;
        }

        .score-center-text { position: absolute; text-align: center; }
        .score-percent { font-size: 26px; font-weight: 800; color: #1C1C1E; letter-spacing: -0.5px; }
        .score-unit { font-size: 12px; color: #8E8E93; font-weight: 600; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆCSSã®ã¿ã§æç”»ï¼‰ */
        .calendar-icon {
            width: 50px;
            height: 50px;
            background: #fff;
            border: 2px solid #E5E5EA;
            border-radius: 10px;
            position: relative;
            margin: 0 auto 8px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .calendar-icon::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 10px;
            width: 4px;
            height: 8px;
            background: #FF3B30;
            border-radius: 2px;
            box-shadow: 22px 0 0 #FF3B30;
        }
        .calendar-icon.today { border-color: #FF3B30; color: #FF3B30; }
        .calendar-val { font-size: 20px; font-weight: 700; color: #1C1C1E; }
        .calendar-icon.today .calendar-val { color: #FF3B30; }
        
        .next-scan-text { text-align: center; font-size: 12px; color: #8E8E93; font-weight: 600; }
        .next-scan-text strong { color: #1C1C1E; font-size: 14px; }

        /* ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ */
        .chart-container {
            width: 100%;
            height: 100px;
            position: relative;
        }
        #trendCanvas { width: 100%; height: 100%; }

        /* åˆ†å¸ƒãƒãƒ¼ */
        .dist-bar-container { margin-top: 8px; }
        .distribution-bar {
            height: 16px;
            width: 100%;
            background: #F2F2F7;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
        }
        .dist-segment { height: 100%; transition: width 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .dist-legend {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .dist-item {
            display: flex;
            align-items: center;
            font-size: 10px;
            color: #666;
            font-weight: 600;
            background: #F9F9F9;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .dist-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
            padding: 0 4px;
            margin-top: 32px;
        }
        .section-title { font-size: 20px; font-weight: 800; color: #1C1C1E; }
        .section-more { font-size: 12px; color: #0A84FF; font-weight: 600; }

        .history-list { display: flex; flex-direction: column; gap: 12px; }

        .history-item {
            background: white;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
        }
        .history-item:active { transform: scale(0.98); background: #fafafa; }
        
        .history-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 16px;
            flex-shrink: 0;
        }
        .history-content { flex: 1; }
        .history-result-text { font-size: 16px; font-weight: 700; color: #1C1C1E; margin-bottom: 2px; }
        .history-date-text { font-size: 12px; color: #8E8E93; font-weight: 500; }
        .history-arrow { color: #C7C7CC; margin-right: 12px; }
        .history-delete-btn {
            background: none; border: none; padding: 8px;
            color: #C7C7CC; transition: color 0.2s;
            display: flex; align-items: center;
        }
        .history-delete-btn:active { color: #FF3B30; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8E8E93;
            font-size: 14px;
            background: white;
            border-radius: 20px;
            border: 2px dashed #E5E5EA;
        }

        /* å›ºå®šãƒœãƒˆãƒ ãƒœã‚¿ãƒ³ */
        .bottom-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 20px calc(20px + env(safe-area-inset-bottom)) 20px;
            background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 100;
            border-top: 1px solid rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
        }

        .scan-fab {
            width: 100%;
            max-width: 400px;
            height: 56px;
            background: #0A84FF;
            color: white;
            border: none;
            border-radius: 28px;
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(10, 132, 255, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .scan-fab:active { transform: scale(0.96); box-shadow: 0 4px 10px rgba(10, 132, 255, 0.2); }
        .scan-fab svg { width: 24px; height: 24px; }

        /* ----------------
           ã‚«ãƒ¡ãƒ©ãƒšãƒ¼ã‚¸ & ãã®ä»–
           ---------------- */
        .camera-view {
            position: relative;
            width: 100%;
            height: 100dvh;
            background: #000;
        }
        /* å¤–ã‚«ãƒ¡ãƒ©ãªã®ã§åè»¢ã—ãªã„ */
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            padding: max(env(safe-area-inset-top), 16px) 16px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
        }
        .back-btn, .help-icon, .zoom-btn {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white; display: flex; align-items: center; justify-content: center;
        }
        .scan-zone {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 280px; height: 180px; z-index: 10; transition: all 0.3s;
        }
        .scan-zone.zoomed { width: 340px; height: 220px; }
        .scan-border {
            width: 100%; height: 100%; border: 2px solid rgba(255,255,255,0.8);
            border-radius: 20px; position: relative;
            box-shadow: 0 0 0 2000px rgba(0,0,0,0.6);
        }
        .scan-hint {
            position: absolute; top: -60px; left: 0; right: 0; text-align: center;
            color: white; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.4); padding: 6px 16px; border-radius: 20px;
            display: inline-block; width: fit-content; margin: 0 auto;
        }
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 24px 24px 0 0;
            padding: 24px 20px calc(24px + env(safe-area-inset-bottom)) 20px; z-index: 50;
        }
        .result-box { text-align: center; margin-bottom: 20px; }
        .result-title { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .result-message { color: #666; font-size: 14px; }
        .capture-btn {
            width: 72px; height: 72px; border-radius: 50%; background: #0A84FF;
            border: 4px solid white; margin: 0 auto; display: block;
            box-shadow: 0 4px 16px rgba(10, 132, 255, 0.4); position: relative;
        }
        .capture-btn::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            width: 32px; height: 32px; background: white; border-radius: 50%;
        }
        .capture-btn.loading::after {
            background: transparent; border: 3px solid #0A84FF; border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: translate(-50%,-50%) rotate(360deg); } }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-panel {
            background: white; width: 100%; max-width: 400px; border-radius: 24px;
            padding: 24px; max-height: 85vh; overflow-y: auto;
            transform: scale(0.94); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        .modal-title { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 20px; }
        .advice-icon { font-size: 48px; text-align: center; margin-bottom: 10px; }
        .advice-section { background: #F2F2F7; padding: 16px; border-radius: 16px; margin-bottom: 16px; }
        .advice-section h3 { color: #0A84FF; font-size: 14px; font-weight: 700; margin-bottom: 8px; }
        .advice-section p { font-size: 13px; line-height: 1.6; color: #333; margin: 0; }
        .advice-section ul { padding-left: 18px; margin: 0; font-size: 13px; color: #333; }
        .close-btn {
            width: 100%; padding: 16px; background: #0A84FF; color: white; border: none;
            border-radius: 14px; font-size: 16px; font-weight: 600; margin-top: 10px;
        }
        .close-btn.secondary { background: #F2F2F7; color: #000; }
        
        .modal-tabs { display: flex; background: #F2F2F7; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .modal-tab { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 600; color: #8E8E93; border-radius: 8px; }
        .modal-tab.active { background: white; color: #000; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .help-content { display: none; }
        .help-content.active { display: block; }
        .help-item { margin-bottom: 16px; }
        .help-item h3 { font-size: 15px; font-weight: 700; margin-bottom: 6px; }
        .help-item p { font-size: 13px; color: #666; line-height: 1.5; }

        canvas { display: none; }
    </style>
</head>
<body>

    <div class="page active" id="homePage">
        <div class="home-page">
            <div class="home-header">
                <div class="home-titles">
                    <div class="home-title">pH Scanner</div>
                    <div class="home-subtitle">Oral Health Tracker</div>
                </div>
            </div>

            <div class="dashboard-grid">
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <svg class="card-icon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                        <span class="card-label">å¥åº·ç‡</span>
                    </div>
                    <div class="score-ring-container">
                        <svg width="100" height="100" class="score-circle">
                            <circle cx="50" cy="50" r="40" class="score-background"></circle>
                            <circle cx="50" cy="50" r="40" class="score-progress" id="scoreProgress"></circle>
                        </svg>
                        <div class="score-center-text">
                            <div class="score-percent" id="healthyRate">--</div>
                            <div class="score-unit">Healthy</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <svg class="card-icon" style="color: #FF9500;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span class="card-label">æ¬¡å›ç›®å®‰</span>
                    </div>
                    <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                        <div id="calendarIcon" class="calendar-icon">
                            <div class="calendar-val" id="calendarDate">--</div>
                        </div>
                        <div class="next-scan-text" id="nextScanText">
                            å±¥æ­´ãªã—
                        </div>
                    </div>
                </div>

                <div class="dashboard-card card-full">
                    <div class="card-header">
                        <svg class="card-icon" style="color: #AF52DE;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                        <span class="card-label">pHãƒˆãƒ¬ãƒ³ãƒ‰</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendCanvas"></canvas>
                    </div>
                </div>

                <div class="dashboard-card card-full" style="padding-bottom: 16px;">
                    <div class="card-header">
                        <svg class="card-icon" style="color: #30B0C7;" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                        <span class="card-label">çŠ¶æ…‹ã®å†…è¨³</span>
                    </div>
                    <div class="dist-bar-container">
                        <div class="distribution-bar" id="distributionBar"></div>
                    </div>
                    <div class="dist-legend" id="distLegend"></div>
                    <div style="margin-top: 12px; font-size: 11px; color: #8E8E93; text-align: right;">
                        ç·ã‚¹ã‚­ãƒ£ãƒ³: <span id="totalScans" style="font-weight:700; color:#333;">0</span>å›
                    </div>
                </div>

            </div>

            <div class="history-section">
                <div class="section-header">
                    <div class="section-title">è¨˜éŒ²</div>
                </div>
                <div class="history-list" id="historyList">
                    <div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
                </div>
            </div>
        </div>

        <div class="bottom-action-bar">
            <button class="scan-fab" id="startScanBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                ã‚¹ã‚­ãƒ£ãƒ³ã‚’é–‹å§‹
            </button>
        </div>
    </div>

    <div class="page" id="cameraPage">
        <div class="camera-view">
            <video id="video" autoplay playsinline muted></video>

            <div class="top-bar">
                <button class="back-btn" id="backBtn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></button>
                <div style="display:flex; gap:12px;">
                    <button class="zoom-btn" id="zoomBtn"><span style="font-size:12px; font-weight:800;">1x</span></button>
                    <button class="help-icon" id="helpBtn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></button>
                </div>
            </div>

            <div class="scan-zone" id="scanZone">
                <div class="scan-hint" id="scanHint">ã‚¬ãƒ ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„</div>
                <div class="scan-border"></div>
            </div>

            <div class="bottom-sheet">
                <div class="result-box">
                    <div class="result-title" id="resultTitle" style="color:#333;">æº–å‚™å®Œäº†</div>
                    <div class="result-message" id="resultMessage">æ’®å½±ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</div>
                    <div id="debugData" style="font-size:10px; color:#ccc; margin-top:4px; font-family:monospace;"></div>
                </div>
                <button class="capture-btn" id="captureBtn"></button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="adviceModal">
        <div class="modal-panel">
            <div class="modal-title" id="adviceTitle"></div>
            <div class="advice-icon" id="adviceIcon"></div>
            <div id="adviceContent"></div>
            <button class="close-btn" id="adviceClose">é–‰ã˜ã‚‹</button>
            <button class="close-btn secondary" id="adviceHome" style="margin-top:8px;">ãƒ›ãƒ¼ãƒ ã¸</button>
        </div>
    </div>

    <div class="modal-overlay" id="helpModal">
        <div class="modal-panel">
            <div class="modal-title">ä½¿ã„æ–¹</div>
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="usage">æ’®å½±æ–¹æ³•</div>
                <div class="modal-tab" data-tab="results">çµæœã®è¦‹æ–¹</div>
            </div>
            <div class="help-content active" id="tab-usage">
                <div class="help-item">
                    <h3>1. æº–å‚™</h3>
                    <p>pHãƒã‚§ãƒƒã‚¯ã‚¬ãƒ ã‚’å™›ã¿ã€èˆŒã®ä¸Šã«ä¹—ã›ã‚‹ã‹è†¨ã‚‰ã¾ã›ã¾ã™ã€‚</p>
                </div>
                <div class="help-item">
                    <h3>2. æ’®å½±</h3>
                    <p>æ˜ã‚‹ã„å ´æ‰€ã§ã€ã‚¬ãƒ ãŒæ å†…ã«åã¾ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¾ã™ã€‚</p>
                </div>
            </div>
            <div class="help-content" id="tab-results">
                <div class="help-item">
                    <h3>è‰²ã®æ„å‘³</h3>
                    <p><span style="color:#0A84FF; font-weight:bold;">é’</span>: ç†æƒ³çš„<br>
                    <span style="color:#AF52DE; font-weight:bold;">ç´«</span>: å¥åº·<br>
                    <span style="color:#ff4f7b; font-weight:bold;">ãƒ”ãƒ³ã‚¯</span>: è¦æ³¨æ„<br>
                    <span style="color:#FF3B30; font-weight:bold;">èµ¤</span>: é«˜ãƒªã‚¹ã‚¯</p>
                </div>
            </div>
            <button class="close-btn" id="closeHelp">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <canvas id="imageCanvas"></canvas>

    <script>
        // DOM Elements
        const homePage = document.getElementById('homePage');
        const cameraPage = document.getElementById('cameraPage');
        const video = document.getElementById('video');
        const imageCanvas = document.getElementById('imageCanvas');
        const ctx = imageCanvas.getContext('2d');
        const debugData = document.getElementById('debugData');
        
        // Status & Config
        let stream = null;
        let isFrozen = false;
        let zoomLevel = 1;

        // Colors
        const COLORS = {
            'ç†æƒ³çš„': '#0A84FF',
            'å¥åº·': '#AF52DE',
            'è¦æ³¨æ„': '#ff4f7b',
            'é«˜ãƒªã‚¹ã‚¯': '#FF3B30',
            'ä¸æ˜': '#8E8E93'
        };

        // Storage
        function loadHistory() {
            return JSON.parse(localStorage.getItem('phHistory') || '[]');
        }
        function saveHistory(res) {
            const h = loadHistory();
            h.unshift({ date: new Date().toISOString(), ...res });
            if(h.length > 50) h.pop();
            localStorage.setItem('phHistory', JSON.stringify(h));
            updateDashboard();
        }
        function deleteHistory(index, e) {
            if(e) e.stopPropagation();
            if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const h = loadHistory();
            h.splice(index, 1);
            localStorage.setItem('phHistory', JSON.stringify(h));
            updateDashboard();
        }

        // Dashboard Logic
        function updateDashboard() {
            const history = loadHistory();
            
            // 1. Health Rate
            const total = history.length;
            document.getElementById('totalScans').textContent = total;
            
            const circle = document.getElementById('scoreProgress');
            const rateTxt = document.getElementById('healthyRate');
            const maxOffset = 251; // 2*PI*40

            if(total > 0) {
                const healthy = history.filter(h => ['ç†æƒ³çš„','å¥åº·'].includes(h.result)).length;
                const rate = Math.round((healthy/total)*100);
                rateTxt.textContent = rate + '%';
                circle.style.strokeDashoffset = maxOffset - (maxOffset * rate / 100);
                circle.style.stroke = rate >= 80 ? COLORS['ç†æƒ³çš„'] : rate >= 50 ? COLORS['å¥åº·'] : COLORS['è¦æ³¨æ„'];
            } else {
                rateTxt.textContent = '--';
                circle.style.strokeDashoffset = maxOffset;
            }

            // 2. Next Scan
            const calIcon = document.getElementById('calendarIcon');
            const calDate = document.getElementById('calendarDate');
            const nextTxt = document.getElementById('nextScanText');
            
            if(total > 0) {
                const last = history[0];
                const lastDate = new Date(last.date);
                const isGood = ['ç†æƒ³çš„','å¥åº·'].includes(last.result);
                const interval = isGood ? 7 : 3;
                
                const nextDate = new Date(lastDate);
                nextDate.setDate(lastDate.getDate() + interval);
                
                const today = new Date();
                today.setHours(0,0,0,0);
                const target = new Date(nextDate);
                target.setHours(0,0,0,0);
                
                const diff = Math.ceil((target - today) / (86400000));
                
                calDate.textContent = nextDate.getDate();
                
                if(diff <= 0) {
                    calIcon.classList.add('today');
                    nextTxt.innerHTML = `<span style="color:#FF3B30; font-weight:700;">ä»Šæ—¥</span>ãŒæ¨å¥¨æ—¥`;
                } else {
                    calIcon.classList.remove('today');
                    nextTxt.innerHTML = `ã‚ã¨<strong>${diff}æ—¥</strong>`;
                }
            } else {
                calDate.textContent = '--';
                calIcon.classList.remove('today');
                nextTxt.textContent = 'ã¾ãšã¯ã‚¹ã‚­ãƒ£ãƒ³';
            }

            // 3. Trend Chart
            drawTrend(history);

            // 4. Distribution
            drawDist(history);

            // 5. History List
            renderList(history);
        }

        function drawTrend(history) {
            const canvas = document.getElementById('trendCanvas');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            ctx.clearRect(0,0,rect.width,rect.height);

            const data = history.slice(0, 10).map(h => {
                if(h.result==='ç†æƒ³çš„') return 100;
                if(h.result==='å¥åº·') return 80;
                if(h.result==='è¦æ³¨æ„') return 50;
                if(h.result==='é«˜ãƒªã‚¹ã‚¯') return 20;
                return 0;
            }).reverse();

            if(data.length < 2) {
                ctx.fillStyle = '#E5E5EA';
                ctx.font = '12px sans-serif';
                ctx.fillText('ãƒ‡ãƒ¼ã‚¿ä¸è¶³', rect.width/2 - 25, rect.height/2);
                return;
            }

            const pad = 5;
            const w = rect.width;
            const h = rect.height - pad*2;
            const step = w / (data.length - 1);

            // Gradient Fill
            ctx.beginPath();
            ctx.moveTo(0, h + pad);
            data.forEach((val, i) => {
                ctx.lineTo(i * step, (h + pad) - (val/100 * h));
            });
            ctx.lineTo(w, h + pad);
            ctx.closePath();
            const grad = ctx.createLinearGradient(0,0,0,h);
            grad.addColorStop(0, 'rgba(10,132,255, 0.2)');
            grad.addColorStop(1, 'rgba(10,132,255, 0)');
            ctx.fillStyle = grad;
            ctx.fill();

            // Line
            ctx.beginPath();
            data.forEach((val, i) => {
                const x = i * step;
                const y = (h + pad) - (val/100 * h);
                if(i===0) ctx.moveTo(x,y);
                else {
                    const prevX = (i-1)*step;
                    const prevY = (h + pad) - (data[i-1]/100 * h);
                    const cx = (prevX + x)/2;
                    ctx.bezierCurveTo(cx, prevY, cx, y, x, y);
                }
            });
            ctx.strokeStyle = '#0A84FF';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function drawDist(history) {
            const container = document.getElementById('distributionBar');
            const legend = document.getElementById('distLegend');
            container.innerHTML = '';
            legend.innerHTML = '';
            
            if(history.length === 0) return;
            
            const counts = {};
            history.forEach(h => counts[h.result] = (counts[h.result] || 0) + 1);
            const total = history.length;

            ['ç†æƒ³çš„','å¥åº·','è¦æ³¨æ„','é«˜ãƒªã‚¹ã‚¯'].forEach(key => {
                if(!counts[key]) return;
                const per = (counts[key]/total)*100;
                
                // Bar segment
                const div = document.createElement('div');
                div.className = 'dist-segment';
                div.style.width = per + '%';
                div.style.backgroundColor = COLORS[key];
                container.appendChild(div);

                // Legend
                const leg = document.createElement('div');
                leg.className = 'dist-item';
                leg.innerHTML = `<div class="dist-dot" style="background:${COLORS[key]}"></div>${key} ${Math.round(per)}%`;
                legend.appendChild(leg);
            });
        }

        function renderList(history) {
            const list = document.getElementById('historyList');
            if(history.length === 0) {
                list.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            list.innerHTML = history.map((item, i) => {
                const d = new Date(item.date);
                const dateStr = `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                return `
                <div class="history-item" onclick="showAdviceModal('${item.result}', '${item.color}', true)">
                    <div class="history-indicator" style="background:${COLORS[item.result]||'#ccc'}"></div>
                    <div class="history-content">
                        <div class="history-result-text">${item.result}</div>
                        <div class="history-date-text">${dateStr}</div>
                    </div>
                    <div class="history-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                    <button class="history-delete-btn" onclick="deleteHistory(${i}, event)">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
                `;
            }).join('');
        }

        // Navigation
        function goPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(id);
            setTimeout(() => target.classList.add('active'), 50);
        }

        document.getElementById('startScanBtn').onclick = () => {
            goPage('cameraPage');
            startCamera();
        };

        document.getElementById('backBtn').onclick = () => {
            stopCamera();
            goPage('homePage');
            resetCameraUI();
            updateDashboard();
        };

        // Camera Logic
        async function startCamera() {
            try {
                // facingMode: 'environment' ã§å¤–ã‚«ãƒ¡ãƒ©ã‚’æŒ‡å®š
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
            } catch(e) {
                alert('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚HTTPSæ¥ç¶šã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                goPage('homePage');
            }
        }
        function stopCamera() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            video.srcObject = null;
        }

        document.getElementById('captureBtn').onclick = () => {
            if(isFrozen) resetCameraUI();
            else capture();
        };

        function capture() {
            if(!video.srcObject) return;
            video.pause();
            isFrozen = true;
            
            const btn = document.getElementById('captureBtn');
            btn.classList.add('loading');
            document.getElementById('scanHint').textContent = 'è§£æä¸­...';

            setTimeout(analyze, 800);
        }

        function resetCameraUI() {
            video.play();
            isFrozen = false;
            document.getElementById('captureBtn').classList.remove('loading');
            document.getElementById('scanHint').textContent = 'ã‚¬ãƒ ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„';
            document.getElementById('resultTitle').textContent = 'æº–å‚™å®Œäº†';
            document.getElementById('resultTitle').style.color = '#333';
            document.getElementById('resultMessage').textContent = 'æ’®å½±ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—';
        }

        function analyze() {
            document.getElementById('captureBtn').classList.remove('loading');
            
            // Image Processing
            imageCanvas.width = video.videoWidth;
            imageCanvas.height = video.videoHeight;
            const ctx = imageCanvas.getContext('2d');
            
            // å¤–ã‚«ãƒ¡ãƒ©ãªã®ã§åè»¢ã—ãªã„ï¼ˆãã®ã¾ã¾æç”»ï¼‰
            ctx.drawImage(video, 0, 0);

            const cx = imageCanvas.width / 2;
            const cy = imageCanvas.height * 0.4;
            const w = zoomLevel === 1.5 ? 340 : 280;
            const h = zoomLevel === 1.5 ? 220 : 180;
            
            const frame = ctx.getImageData(cx - w/2, cy - h/2, w, h);
            const data = frame.data;
            
            let r=0, g=0, b=0, count=0, lumTot=0;
            for(let i=0; i<data.length; i+=16) {
                const tr=data[i], tg=data[i+1], tb=data[i+2];
                const lum = (tr+tg+tb)/3;
                if(lum < 20 || lum > 250) continue; // Filter dark/bright
                
                // Color saturation check
                const max = Math.max(tr,tg,tb), min = Math.min(tr,tg,tb);
                if((max-min)/max < 0.1) continue; // Skip gray

                r+=tr; g+=tg; b+=tb; lumTot+=lum; count++;
            }

            if(count < 50) {
                showResult('ã‚¨ãƒ©ãƒ¼', 'ã‚¬ãƒ ã‚’èªè­˜ã§ãã¾ã›ã‚“', '#333');
                return;
            }

            const avgR = r/count, avgG = g/count, avgB = b/count;
            const hsv = rgb2hsv(avgR, avgG, avgB);
            
            // Logic
            let title = 'åˆ¤å®šä¸èƒ½', color = '#333';
            
            if(hsv.h >= 340 || hsv.h < 25) { title='é«˜ãƒªã‚¹ã‚¯'; color=COLORS['é«˜ãƒªã‚¹ã‚¯']; }
            else if(hsv.h >= 320 && hsv.h < 340) { title='è¦æ³¨æ„'; color=COLORS['è¦æ³¨æ„']; }
            else if(hsv.h >= 240 && hsv.h < 320) { title='å¥åº·'; color=COLORS['å¥åº·']; }
            else if(hsv.h >= 180 && hsv.h < 240) { title='ç†æƒ³çš„'; color=COLORS['ç†æƒ³çš„']; }

            showResult(title, hsv.h, color);
        }

        function rgb2hsv(r,g,b) {
            r/=255; g/=255; b/=255;
            const max=Math.max(r,g,b), min=Math.min(r,g,b);
            let h=0, d=max-min;
            if(d!==0) {
                if(max===r) h=(g-b)/d + (g<b?6:0);
                else if(max===g) h=(b-r)/d + 2;
                else h=(r-g)/d + 4;
                h/=6;
            }
            return { h: h*360 };
        }

        function showResult(title, hue, color) {
            const titleEl = document.getElementById('resultTitle');
            titleEl.textContent = title;
            titleEl.style.color = color;
            document.getElementById('resultMessage').textContent = title==='ã‚¨ãƒ©ãƒ¼' ? 'å†æ’®å½±ã—ã¦ãã ã•ã„' : 'åˆ¤å®šå®Œäº†';
            
            if(title !== 'ã‚¨ãƒ©ãƒ¼') {
                saveHistory({ result: title, color: color, hue: Math.round(hue) });
                setTimeout(() => showAdviceModal(title, color), 800);
            }
        }

        // Advice Modal
        function showAdviceModal(title, color, isHistoryMode = false) {
            const modal = document.getElementById('adviceModal');
            const icons = { 'é«˜ãƒªã‚¹ã‚¯':'âš ï¸', 'è¦æ³¨æ„':'âš¡', 'å¥åº·':'ğŸ‘', 'ç†æƒ³çš„':'ğŸŒŸ' };
            const texts = {
                'é«˜ãƒªã‚¹ã‚¯': 'å£å†…ãŒé…¸æ€§ã§ã™ã€‚ã™ãã«æ­¯ç£¨ãã‹æ°´æ´—ã„ã‚’æ¨å¥¨ã—ã¾ã™ã€‚',
                'è¦æ³¨æ„': 'ã‚„ã‚„é…¸æ€§å‚¾å‘ã§ã™ã€‚ã‚¬ãƒ ã‚’å™›ã‚€ã‹æ°´ã‚’é£²ã¿ã¾ã—ã‚‡ã†ã€‚',
                'å¥åº·': 'è‰¯å¥½ãªçŠ¶æ…‹ã§ã™ã€‚ã“ã®èª¿å­ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚',
                'ç†æƒ³çš„': 'å®Œç’§ãªçŠ¶æ…‹ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ã‚±ã‚¢ç¿’æ…£ã§ã™ã€‚'
            };

            document.getElementById('adviceIcon').textContent = icons[title] || '';
            const tEl = document.getElementById('adviceTitle');
            tEl.textContent = title;
            tEl.style.color = color;
            
            document.getElementById('adviceContent').innerHTML = `
                <div class="advice-section">
                    <h3>ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                    <p>${texts[title]||''}</p>
                </div>
            `;
            
            // ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡ï¼ˆå±¥æ­´ã‹ã‚‰ã®é–²è¦§ãªã‚‰éè¡¨ç¤ºï¼‰
            document.getElementById('adviceHome').style.display = isHistoryMode ? 'none' : 'block';
            
            modal.classList.add('show');
            modal.querySelector('.modal-panel').style.transform = 'scale(1)';
        }

        function closeAdvice(goHome) {
            const modal = document.getElementById('adviceModal');
            modal.querySelector('.modal-panel').style.transform = 'scale(0.94)';
            modal.classList.remove('show');
            
            if(goHome) {
                setTimeout(() => {
                    stopCamera();
                    goPage('homePage');
                    resetCameraUI();
                    updateDashboard();
                }, 300);
            }
        }

        document.getElementById('adviceClose').onclick = () => closeAdvice(false);
        document.getElementById('adviceHome').onclick = () => closeAdvice(true);
        
        // Help & Zoom
        document.getElementById('zoomBtn').onclick = function() {
            zoomLevel = zoomLevel===1 ? 1.5 : 1;
            this.querySelector('span').textContent = zoomLevel+'x';
            // åè»¢ãªã—ã®ã‚ºãƒ¼ãƒ 
            video.style.transform = `scale(${zoomLevel})`;
            document.getElementById('scanZone').classList.toggle('zoomed', zoomLevel===1.5);
        };
        
        const helpModal = document.getElementById('helpModal');
        document.getElementById('helpBtn').onclick = () => {
            helpModal.classList.add('show');
            helpModal.querySelector('.modal-panel').style.transform = 'scale(1)';
        };
        document.getElementById('closeHelp').onclick = () => {
            helpModal.classList.remove('show');
            helpModal.querySelector('.modal-panel').style.transform = 'scale(0.94)';
        };
        document.querySelectorAll('.modal-tab').forEach(t => {
            t.onclick = () => {
                document.querySelectorAll('.modal-tab').forEach(x=>x.classList.remove('active'));
                document.querySelectorAll('.help-content').forEach(x=>x.classList.remove('active'));
                t.classList.add('active');
                document.getElementById('tab-'+t.dataset.tab).classList.add('active');
            }
        });

        // Init
        updateDashboard();
    </script>
</body>
</html>
